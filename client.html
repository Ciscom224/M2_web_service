<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse de Solvabilit√© et D√©cision d‚ÄôApprobation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
    h1 { color: #333; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 20px; margin-top: 10px; border: none; border-radius: 5px; background-color: #333; color: white; cursor: pointer; }
    button:hover { background-color: #555; }
    .result { margin-top: 20px; padding: 15px; background: #fff; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .solvable { color: green; font-weight: bold; }
    .non-solvable { color: red; font-weight: bold; }
    .loading { color: #007BFF; font-style: italic; }
    .section { margin-top: 10px; padding: 10px; border-top: 1px solid #ddd; }
  </style>
</head>
<body>
  <div id="auth">
    <h1>Authentification</h1>
    <input type="text" id="id_client" placeholder="ID Client (ex: client-001)">
    <input type="password" id="code_secret" placeholder="Code Secret">
    <button onclick="login()">Se Connecter</button>
  </div>

  <div id="service" style="display:none;">
    <h1>Demande de Pr√™t Immobilier</h1>
    <textarea id="demande" placeholder="Ex : Je souhaite un pr√™t immobilier de 250000 euros sur 20 ans pour acheter une maison √† Lyon..."></textarea><br>
    <button onclick="submitDemande()">Soumettre</button>
    <div class="result" id="result"></div>
  </div>

<script>
  let auth = {};

  function login() {
    const id = document.getElementById('id_client').value.trim();
    const code = document.getElementById('code_secret').value.trim();

    if (!/^client-\d{3}$/.test(id)) {
      return alert("‚ö†Ô∏è Le format du Client ID doit √™tre client-XXX (ex: client-001)");
    }
    if (code === "") return alert("Veuillez entrer le code secret");

    auth.id_client = id;
    auth.code_secret = code;

    alert("‚úÖ Connexion r√©ussie !");
    document.getElementById("auth").style.display = "none";
    document.getElementById("service").style.display = "block";
  }

  async function submitDemande() {
    const texte = document.getElementById('demande').value.trim();
    if (!texte) return alert("Veuillez entrer votre demande.");

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = "<p class='loading'>‚è≥ Analyse en cours...</p>";

    const soapRequest = `
    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                      xmlns:urn="urn:solvency.verification.service:v1">
       <soapenv:Body>
          <urn:VerifySolvency>
             <urn:clientId>${auth.id_client}</urn:clientId>
             <urn:demandeTexte>${texte}</urn:demandeTexte>
          </urn:VerifySolvency>
       </soapenv:Body>
    </soapenv:Envelope>`;

    try {
      const response = await fetch("http://localhost:8000/", {
        method: "POST",
        headers: { 
          "Content-Type": "text/xml;charset=UTF-8",
          "SOAPAction": "VerifySolvency"
        },
        body: soapRequest
      });

      if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);

      const responseText = await response.text();
      console.log("üßæ R√©ponse SOAP :", responseText);

      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(responseText, "text/xml");

      // Namespaces r√©els observ√©s
      const ns = "urn:solvency.verification.service:v1";
      const nsExplain = "urn:solvency.verifxication.service:v1";
      const nsApproval = "data.models";

      const get = (nsURI, tag) => xmlDoc.getElementsByTagNameNS(nsURI, tag)[0]?.textContent || "Non disponible";

      // Donn√©es client
      const name = get(ns, "name");
      const address = get(ns, "address");
      const income = get(ns, "MonthlyIncome");
      const expenses = get(ns, "Expenses");
      const debt = get(ns, "debt");
      const late = get(ns, "late");
      const bankruptcy = get(ns, "hasBankruptcy");
      const score = get(ns, "creditScore");
      const status = get(ns, "solvencyStatus");

      // Explications
      const expScore = get(nsExplain, "creditScoreExplanation");
      const expIncome = get(nsExplain, "incomeVsExpensesExplanation");
      const expHistory = get(nsExplain, "creditHistoryExplanation");

      // √âvaluation de la propri√©t√©
      const estimatedValue = get(nsExplain, "estimatedValue");
      const legalCompliance = get(nsExplain, "legalCompliance");
      const evaluationReport = get(nsExplain, "evaluationReport");
      const canProceed = get(nsExplain, "canProceed");

      // Approbation finale
      const approved = get(nsApproval, "approved");
      const interestRate = get(nsApproval, "interestRate");
      const maxLoanAmount = get(nsApproval, "maxLoanAmount");
      const decisionReport = get(nsApproval, "decisionReport");

      const isSolvent = status === "solvent";
      const canBuy = canProceed === "true" || canProceed === "True";
      const isApproved = approved === "true" || approved === "True";

      resultDiv.innerHTML = `
        <h3>üìã R√©sultat complet d‚Äôanalyse</h3>

        <div class="section">
          <h4>üë§ Informations client</h4>
          <p><strong>Nom :</strong> ${name}</p>
          <p><strong>Adresse :</strong> ${address}</p>
        </div>

        <div class="section">
          <h4>üí∞ Situation financi√®re</h4>
          <p><strong>Revenus mensuels :</strong> ${income} ‚Ç¨</p>
          <p><strong>D√©penses :</strong> ${expenses} ‚Ç¨</p>
        </div>

        <div class="section">
          <h4>üè¶ Historique de cr√©dit</h4>
          <p><strong>Dette :</strong> ${debt} ‚Ç¨</p>
          <p><strong>Paiements en retard :</strong> ${late}</p>
          <p><strong>Faillite :</strong> ${bankruptcy}</p>
        </div>

        <div class="section">
          <h4>üìä Analyse globale</h4>
          <p><strong>Score :</strong> ${score}</p>
          <p><strong>Statut :</strong> <span class="${isSolvent ? 'solvable' : 'non-solvable'}">${status}</span></p>
        </div>

        <div class="section">
          <h4>üß† Explications d√©taill√©es</h4>
          <p><strong>Score :</strong> ${expScore}</p>
          <p><strong>Revenus vs D√©penses :</strong> ${expIncome}</p>
          <p><strong>Historique :</strong> ${expHistory}</p>
        </div>

        <div class="section">
          <h4>üè† √âvaluation de la propri√©t√©</h4>
          <p><strong>Valeur estim√©e :</strong> ${estimatedValue} ‚Ç¨</p>
          <p><strong>Conformit√© l√©gale :</strong> ${legalCompliance}</p>
          <p><strong>Rapport :</strong> ${evaluationReport}</p>
          <p><strong>Peut proc√©der √† l‚Äôachat :</strong> <span class="${canBuy ? 'solvable' : 'non-solvable'}">${canProceed}</span></p>
        </div>

        <div class="section">
          <h4>‚úÖ D√©cision finale d‚Äôapprobation</h4>
          <p><strong>Approuv√© :</strong> <span class="${isApproved ? 'solvable' : 'non-solvable'}">${approved}</span></p>
          <p><strong>Taux d‚Äôint√©r√™t :</strong> ${interestRate} %</p>
          <p><strong>Montant maximum accord√© :</strong> ${maxLoanAmount} ‚Ç¨</p>
          <p><strong>Rapport d‚Äôanalyse :</strong> ${decisionReport}</p>
        </div>
      `;
    } catch (error) {
      console.error("Erreur :", error);
      resultDiv.innerHTML = `<p style="color:red;">‚ùå Erreur : ${error.message}</p>`;
    }
  }
</script>

</body>
</html>
